define("tiny_medial/ui",["exports","core/modal_factory","core/modal_events","tiny_medial/modal","./options","tiny_medial/link","tiny_medial/selectors"],(function(_exports,_modal_factory,_modal_events,_modal,_options,_link,_selectors){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny Medial UI.
   *
   * @module      tiny_medial/ui
   * @copyright   2023 Tim Williams, Streaming Ltd <tim@medial.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.receiveMessage=_exports.insertLibLink=_exports.handleAction=void 0,_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_modal=_interopRequireDefault(_modal),_selectors=_interopRequireDefault(_selectors);let preid=-1,gotIn=!1,interval=null,ed=null,modalPromises=!1;_exports.handleAction=function(editor){let unlink=arguments.length>1&&void 0!==arguments[1]&&arguments[1];unlink||displayDialogue(editor)};const displayDialogue=async editor=>{ed=editor,modalPromises=await _modal_factory.default.create({type:_modal.default.TYPE,templateContext:getTemplateContext(editor),large:!0}),modalPromises.show();const $root=await modalPromises.getRoot(),root=$root[0];$root.on(_modal_events.default.hidden,(()=>{window.removeEventListener("message",receiveMessage),modalPromises.destroy(),modalPromises=!1})),$root.on(_modal_events.default.shown,(()=>{console.log("add listener"),window.addEventListener("message",receiveMessage,!1)})),root.addEventListener("click",(e=>{e.target.closest(_selectors.default.actions.submit)&&(e.preventDefault(),(0,_link.setLink)(preid,getLinkType(editor),editor),modalPromises.destroy())}))},getLinkType=editor=>document.getElementById("medial_insert_type_"+editor.id).value,getTemplateContext=editor=>Object.assign({},{elementid:editor.id,edit:!0,medialurl:(0,_options.getLtiurl)(editor),launchurl:(0,_options.getBaseurl)(editor)+"/mod/helixmedia/launch.php?type="+(0,_options.getLaunchType)(editor)+"&modtype="+(0,_options.getModType)(editor),hideinsert:(0,_options.getHideInsert)(editor),embedopt:(0,_options.getEmbedOpt)(editor)},{}),receiveMessage=event=>{if(console.log("recieveMessage"),console.log(event.data),console.log(typeof event.data),"string"==typeof event.data){var i=event.data.indexOf("preid_");console.log("i="+i),0==i&&(console.log("start checkStatus"),preid=event.data.substring(6),interval=setTimeout(checkStatus,5e3))}};_exports.receiveMessage=receiveMessage;const checkStatus=()=>{var xmlDoc=new XMLHttpRequest,params="resource_link_id="+preid+"&user_id="+(0,_options.getUserId)(ed)+"&oauth_consumer_key="+(0,_options.getOauthConsumerKey)(ed);xmlDoc.onload=response=>{if(console.log("status"),console.log(response),modalPromises)if(response.target.status<200&&response.target.status>=400)setInsertDisplay("inline");else if("IN"==response.target.responseText&&(gotIn=!0,setInsertDisplay("none")),"OUT"==response.target.responseText&&1==gotIn){gotIn=!1,(0,_options.getHideInsert)(ed)||setInsertDisplay("inline");var delay=(0,_options.getInsertDelay)(ed);delay>-1&&(0==delay?((0,_link.setLink)(preid,getLinkType(ed),ed),modalPromises.destroy()):setTimeout((()=>{(0,_link.setLink)(preid,getLinkType(ed),ed),modalPromises.destroy()}),1e3*delay))}else interval=setTimeout(checkStatus,2e3);else gotIn=!1},xmlDoc.open("POST",(0,_options.getStatusUrl)(ed),!0),xmlDoc.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xmlDoc.send(params)},setInsertDisplay=state=>{var e=document.getElementById("mod_helixmedia_launchframebutton_"+ed.id);void 0!==e&&(e.style.display=state)};_exports.insertLibLink=editor=>{window.console.log("insertLibLink"),window.console.log(editor),(0,_link.setMedialLink)(0,"library",editor,0,(0,_options.getLibLaunchType)(editor),"tiny_medial/library")}}));

//# sourceMappingURL=ui.min.js.map